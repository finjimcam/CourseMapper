image: "python:3.10-slim"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

cache:
  paths:
    - deps_cache
    - venv/

before_script:
  - python3.10 -m venv venv
  - source venv/bin/activate
  - pip install --upgrade pip
  - pip install -r backend/requirements.txt --cache-dir deps_cache

stages:
  - Static Analysis
  - Dynamic Analysis

Checking Rebase:
  stage: Static Analysis
  script:
    # Fetch main and check if the branch is behind
    - git fetch origin main
    - if [ "$(git rev-parse HEAD)" != "$(git merge-base HEAD origin/main)" ]; then
        echo "Branch is not rebased onto main. Please rebase.";
        exit 1;
      fi
  rules:
    # Only run this job for merge requests
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

Linting with black:
  stage: Static Analysis
  script:
    - black --check --diff --line-length 99 backend
  rules:
    changes:
      - backend/**/*

Type checking with mypy:
  stage: Static Analysis
  script:
    - mypy --strict backend
  rules:
    changes:
      - backend/**/*

Unit tests on backend:
  stage: Dynamic Analysis
  script:
    - python -m unittest discover -s backend -p "test_*.py"
  rules:
    changes:
      - backend/**/*
